name: Android CI Build

on:
  push:
    branches: [ "master", "dev" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch: # امکان اجرای دستی

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake python3 wget unzip

    - name: Install Android NDK
      run: |
        # استفاده از NDK پیش‌فرض موجود در رانرهای گیت‌هاب
        echo "ANDROID_NDK_HOME=${ANDROID_SDK_ROOT}/ndk-bundle" >> $GITHUB_ENV

    - name: Patch CMakeLists for Shared Library
      run: |
        # این بخش به صورت خودکار add_executable را به add_library SHARED تغییر می‌دهد
        sed -i 's/add_executable(${CMAKE_PROJECT_NAME}/add_library(${CMAKE_PROJECT_NAME} SHARED/g' CMakeLists.txt
        echo "CMakeLists.txt has been patched to build a SHARED library (.so)"

    - name: Build XMRig for Android (arm64-v8a)
      run: |
        mkdir build && cd build
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=${ANDROID_SDK_ROOT}/ndk-bundle/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-21 \
          -DWITH_HWLOC=OFF \
          -DWITH_LIBCPUID=OFF \
          -DWITH_OPENSSL=ON \
          -DBUILD_STATIC=OFF \
          -DWITH_ADLER=OFF
        
        make -j$(nproc)

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: xmrig-android-so
        path: build/libxmrig.so
